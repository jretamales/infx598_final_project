<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
    <h1>Visualizing Multitasking</h1>
        <div class="explanation">
            <p>Explain the experiment here dfodsfkosdkfokdfsokdsfokdfsokdfsokdfsokdsoksdfokodskodfkodskfodskokdfsokdsoksdffokdfsokdfodfs
            dskjdsfijdfsijdfsijdfsjdfskjdfskjdfksjdfskjdfskjdfskjdfskjdfs
            dsfksdfjfdskjkdfsjkdf</p>
        </div>
    <div class="experimentation" id="rows">
        <h2>Type each word and numbers repeatedly</h2>
        <h3>First the word "visualize" in the first row below</h3>
        <input type ="text" class="input_exp letter rep" id = "first_letter_repeat" maxlength=1/>
        <input type ="text" class="input_exp letter rep" maxlength=1/>
        <input type ="text" class="input_exp letter rep" maxlength=1/>
        <input type ="text" class="input_exp letter rep" maxlength=1/>
        <input type ="text" class="input_exp letter rep" maxlength=1/>
        <input type ="text" class="input_exp letter rep" maxlength=1/>
        <input type ="text" class="input_exp letter rep" maxlength=1/>
        <input type ="text" class="input_exp letter rep" maxlength=1/>
        <input type ="text" class="input_exp letter rep" maxlength=1/>
        <h3>Continue typing the numbers from 1 to 9 in the second row</h3>
        <input type ="text" class="input_exp number rep" maxlength=1 />
        <input type ="text" class="input_exp number rep" maxlength=1/>
        <input type ="text" class="input_exp number rep" maxlength=1/>
        <input type ="text" class="input_exp number rep" maxlength=1/>
        <input type ="text" class="input_exp number rep" maxlength=1/>
        <input type ="text" class="input_exp number rep" maxlength=1/>
        <input type ="text" class="input_exp number rep" maxlength=1/>
        <input type ="text" class="input_exp number rep" maxlength=1/>
        <input type ="text" class="input_exp number rep" id = "last_number_repeat" maxlength=1 />
    </div>
    <div class="experimentation" id="columns">
        <h2>Now it's the same task but alternating</h2>
        <h3>Type alternately the word visualize and numbers 1 to 9</h3>
        <div class ="alternate">
            <input type ="text" class="input_exp letter" maxlength=1 id = "first_letter_alt"/>
            <input type ="text" class="input_exp number" maxlength=1 />
            <input type ="text" class="input_exp letter" maxlength=1 />
            <input type ="text" class="input_exp number" maxlength=1/>
            <input type ="text" class="input_exp letter" maxlength=1 />
            <input type ="text" class="input_exp number" maxlength=1/>
            <input type ="text" class="input_exp letter" maxlength=1/>
            <input type ="text" class="input_exp number" maxlength=1/>
            <input type ="text" class="input_exp letter" maxlength=1/>
            <input type ="text" class="input_exp number" maxlength=1/>
            <input type ="text" class="input_exp letter" maxlength=1/>
            <input type ="text" class="input_exp number" maxlength=1/>
            <input type ="text" class="input_exp letter" maxlength=1/>
            <input type ="text" class="input_exp number" maxlength=1/>
            <input type ="text" class="input_exp letter" maxlength=1/>
            <input type ="text" class="input_exp number" maxlength=1/>
            <input type ="text" class="input_exp letter" maxlength=1/>
            <input type ="text" class="input_exp number" maxlength=1 id = "last_number_alt"/>
        </div>
    </div>
    <div class = "clocks">
    </div>
    <div class = "explanation">
        <h2>Visualization</h2>
    <p>Explain visualization here dkfnojdidflksdfkjhdsfklsdkjhksdhfksdhfkjshdfkjhsdkjhksdjfhkjdshhdshkshdfkjdsfhkjhdfskhdfskdfhs\
    dsfdsjfhdskfhksdfjkdfjkdf</p>
    </div>
    <div id="Chart"></div>
    <div class = "controls">
        <div class = "mycheckox">
            <ul class="checkbox-grid">
                <li><input type="checkbox" value= "8-2" name="checkbox15" id = "checkbox1">
                    <label for="checkbox1">Writing short Email</label>
                    <p style="display: inline">(8 min, mid familiarity)</p>
                </li>
                <li><input type="checkbox" value= "5-1" name="checkbox15" id = "checkbox2">
                    <label for="checkbox2">Creating a simple bar chart</label>
                    <p style="display: inline">(5 min, low familiarity)</p>
                </li>
                <li><input type="checkbox" value= "8-2" name="checkbox15" id = "checkbox3">
                    <label for="checkbox3">Cleaning up desktop</label>
                    <p style="display: inline">(8 min, mid familiarity)</p>
                </li>
                <li><input type="checkbox" value= "9-4" name="checkbox15" id = "checkbox4">
                    <label for="checkbox4">Adding up weekly expenses</label>
                    <p style="display: inline">(9 min, High familiarity)</p>
                </li>
            </ul>
        </div>
        <hr width="95%">
        <div class = "myslider">
            <input type="range" id="MTlevelSlider" name = "myslider" class="vHorizon" min="1" max="50" step="1" value="1"
                   style="background-color: #00aec8;">
            <label for="textInput">Number of Switches:</label>
            <input type="text" id="textInput" value="1" readonly style="border:0; color:#f6931f;
            font-weight:bold;">
        </div>
    </div>
    <script src="00_js_libs/d3.v3.js"></script>
    <script src="00_js_libs/d3-timer.v0.3.min.js"></script>
    <script type="text/javascript" src="00_js_libs/jquery-1.10.2.js"></script>
	<script type="text/javascript">
	</script>
	<script>

        // STAGE 0: HERE WE CREATE THE ORIGINAL ARRAYS BASED ON THE CHECKBOX LABELS AND THE PRESPECIFIED TIME THAT EACH
        // TASK TAKE AND THEIR FAMILIARITY.
        var start_rep = 0;
        var end_rep = 0;
        var start_alt = 0;
        var end_alt = 0;

        // shift focus to next field
        $(".input_exp").keyup(function () {
            if (this.value.length == this.maxLength) {
                $(this).next('.input_exp').focus();
            }
        });


        // whenever the user starts typing we start the clock
        $("#first_letter_repeat").change(function(){
            start_rep = new Date();
            (function update() {
                var now = new Date();
                if (end_rep===0) {
                    field_rep
                            .each(function (d) {
                                d.previous = d.value, d.value = d.update(now);
                            }); // maybe here just changing
                    // each for something more manual works, try this first.

                path_rep.transition()
                        .ease("elastic")
                        .duration(750)
                        .attrTween("d", arcTween);

                label_rep
                        .text(function(d) { return d.value + d.label; });

                setTimeout(update, 1000 - (now % 1000));
                }
            })()
        });

        $("#last_number_repeat").change(function(){
            end_rep = new Date();
        });

        // whenever the user starts typing we start the second clock
        $("#first_letter_alt").change(function(){
            start_alt = new Date();
            (function update() {
                var now = new Date();
                if (end_alt===0) {
                    field_alt
                            .each(function (d) {
                                d.previous = d.value, d.value = d.update(now);
                            }); // maybe here just changing
                    // each for something more manual works, try this first.

                    path_alt.transition()
                            .ease("elastic")
                            .duration(750)
                            .attrTween("d", arcTween);

                    label_alt
                            .text(function(d) { return d.value + d.label; });

                    setTimeout(update, 1000 - (now % 1000));
                }
            })()
        });

        $("#last_number_alt").change(function(){
            end_alt = new Date();
        });

        var orig_tasks_array = [];
        var color_domain =['Ramp up'];

        var allcheckboxes = document.getElementsByName("checkbox15");

        for(var i = 0, len = allcheckboxes.length; i < len; i++) {
            var label = getLabel(allcheckboxes[i].id);
            var value = allcheckboxes[i].value;
            orig_tasks_array.push({
                task: label,
                time: Number(value.split("-")[0]), // first argument is the time it takes for each task
                ramp_up_time: 6,
                familiarity: Number(value.split("-")[1])// second argument is the time it takes for each task
            });
            color_domain.push(label);
        }

        // STAGE 1: HERE WE CREATE ALL THE FUNCTIONS THAT WE NEED TO USE IN OUR CODE.
        function lookup_obj(obj, val){
            for(i=0; i < obj.length; i++){
                if(obj[i].task === val){
                    return obj[i].familiarity;
                }
            }
        }

        function getLabel(id){
            return $("#"+id).next("label").html();
        }

        function append_ramp_up(checkbox_array, n_switches, penalty_val){  /// *** need to fix here the bordeline condition with only one
            // task... there should be no rampup time.
            // also add penalizer for ramp_up time.
            var new_result = [];
            for (var i = 0; i<=n_switches;i++){
                for (var j = 0; j < checkbox_array.length; j++) {
                    current_familiarity = lookup_obj(orig_tasks_array , checkbox_array[j].task);
                    if(j != 0) {
                        prior_familiarity = lookup_obj(orig_tasks_array , checkbox_array[(j-1)].task);
                        new_result.push({
                            task: "Ramp up",
                            time: 0.487 + 0.118*prior_familiarity - 0.069*current_familiarity // this from the paper
                        });
                        new_result.push({task: checkbox_array[j].task, time: (checkbox_array[j].time) / (n_switches + 1)});
                    }// object here with time.
                    else{
                        new_result.push({
                            task: "Ramp up",
                            time: 0});
                        new_result.push({task: checkbox_array[j].task, time: (checkbox_array[j].time) / (n_switches + 1)});
                    }
                    }
                }
            return new_result;
        }

        function rename_y(stacked_obj){ // simple function to rename y objects to x.
            for(i = 0; i < stacked_obj.length; i++){
                stacked_obj[i].x0 = stacked_obj[i]['y0'];
                stacked_obj[i].x = stacked_obj[i]['y'];
                delete stacked_obj[i].y0;
                delete stacked_obj[i].y;
            }
            return stacked_obj;
        }
        var dataset;

        $(".checkbox-grid li").change(function(event){
            dataset = $("input:checkbox:checked").map(function(){
                return {task: getLabel(this.id), time: (this.value).split("-")[0]};
            }).get();
            render(dataset);
        });

        var slider_val = $('input[name="myslider"]').val();

        $('input[name="myslider"]').change(function(){
            slider_val = $('input[name="myslider"]').val();
            document.getElementById('textInput').value = slider_val;
            render(dataset); // I get an error here. because dataset doesn
        });


// #########################           D3             ######################################################//
        // D3  CLOCKS

        var width_clocks = 300,
                height_clocks = 150;

        var fields_rep = [
            {value: 60, size: 60, label: "m", update: function(date) {tmp_min = Math.floor((date-start_rep)/(60*1000));
                return tmp_min; }},
            {value: 60, size: 60, label: "s", update: function(date) {
                tmp_seg = Math.round((date-start_rep)/1000);
                return tmp_seg-(tmp_min*60);}} // insert start_alt here
        ];

        var arc = d3.svg.arc()
                .innerRadius((height_clocks)/ 4)
                .outerRadius((height_clocks -10)/ 2)
                .startAngle(0)
                .endAngle(function(d) { return (d.value / d.size) * 2 * Math.PI; });

        var svg_rep = d3.select("#rows").append("svg")
                .attr("width", width_clocks)
                .attr("height", height_clocks);

        var field_rep = svg_rep.selectAll(".field")
                .data(fields_rep)
                .enter().append("g")
                .attr("transform", function(d, i) {
                    return "translate("+ (i*height_clocks + height_clocks/2) +"," + height_clocks / 2 + ")"; })
                .attr("class", "field");

        field_rep.append("path")
                .attr("class", "path path--background")
                .attr("d", arc);

        var path_rep = field_rep.append("path")
                .attr("class", "path path--foreground");

        var label_rep = field_rep.append("text")
                .attr("class", "label")
                .attr("dy", ".35em");


        function arcTween(b) {
            var i = d3.interpolate({value: b.previous}, b);
            return function(t) {
                return arc(i(t));
            };
        }

        var fields_alt = [
            {value: 60, size: 60, label: "m", update: function(date) {tmp_min = Math.floor((date-start_alt)/(60*1000));
                return tmp_min; }},
            {value: 60, size: 60, label: "s", update: function(date) {
                tmp_seg = Math.round((date-start_alt)/1000);
                return tmp_seg-(tmp_min*60);}} // insert start_alt here
        ];

        var svg_alt = d3.select("#columns").append("svg")
                .attr("width", width_clocks)
                .attr("height", height_clocks)
                .style('display', 'inline-block');

        var field_alt = svg_alt.selectAll(".field")
                .data(fields_alt)
                .enter().append("g")
                .attr("transform", function(d, i) {
                    return "translate("+ (i*height_clocks + height_clocks/2) +"," + height_clocks / 2 + ")"; })
                .attr("class", "field");

        field_alt.append("path")
                .attr("class", "path path--background")
                .attr("d", arc);

        var path_alt = field_alt.append("path")
                .attr("class", "path path--foreground");

        var label_alt = field_alt.append("text")
                .attr("class", "label")
                .attr("dy", ".35em");


        // D3 bars
        var margin = {top: 10, right: 70, bottom: 10, left: 50};
        var width = 800;
        var height = 110;
        var bar_spacing = 20;
        var sim_y_position = margin.top + (height+bar_spacing)/2;
        var bar_height = (height-bar_spacing)/2;

        var svg = d3.select("#Chart").append("svg")
                .classed("svg-area", true)
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);

        var g_base = svg.append("g")
              .classed("plot", true)
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var g_sim = svg.append("g")
                .classed("plot", true)
                .attr("transform", "translate(" + margin.left + "," + sim_y_position + ")");

        var xAxisG = d3.select(".plot").append("g")
            .attr("class", "x-axis")
            .attr("transform", "translate(0," + margin.top + ")"); // fix this, is not showing

        //here we are just adding all the values to compute the time total. That way we can scale appropriately.
        var timeTotal = 0;  // Variable to hold your total

        for(var i = 0, len = allcheckboxes.length; i < len; i++) {
            var iter = allcheckboxes[i].value;
            timeTotal += Number(iter.split("-")[0]);  // Iterate over your first array and then grab the second element add the values up
        }

        var xScale = d3.scale
                .linear()
                .domain([0, timeTotal*4])
                .range([0, width]);

        var yScale = d3.scale.ordinal()
                    .rangeBands([0, height]);

        var color = d3.scale.ordinal()
                .domain(color_domain)
                .range(["#000000", "#1f77b4","#ff7f0e","#2ca02c", "#d62728", "#9467bd",
                    "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"]) // custom scale to include black for rampup;

        var xAxis = d3.svg
                    .axis()
                        .scale(xScale)
                        .orient("top");

        var tooltip = d3.select("body")
                .append("div")
                .classed("tooltip", true)
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden");

        // 1 here insert another parameter to be able to use it within the function.
        function render(data){

            xAxisG.call(xAxis);

            var stack = d3.layout.stack()// this is just a function so we can reuse it for the simulation plot.
            .y(function (d){
                return d.time;
            })
            .values(function(d){
                return [d];
            });

            // Baseline bar

            var data_baseline = append_ramp_up(data, 0, 1); // the second param is zero because we are splitting it
            // 0 times which is our baseline.

            var stacked_baseline = stack(data_baseline); // gives us a stacked object with y0 and y...
            // But we don't really want a vertical barchart we want it to be horizontal so, lets rename it

            stacked_baseline = rename_y(stacked_baseline);

            console.log(stacked_baseline);

            yScale.domain(stacked_baseline.map(function(d){
                return d.task;
            }));


            // join
            var rects_base = g_base.selectAll("rect")
                  .data(stacked_baseline);

            //enter phase
            rects_base.enter().append("rect");

            //update phase
            rects_base.attr("x", function(d){return xScale(d.x0)})
                    .style("fill", function(d){return color(d.task)})
                    .attr("y", margin.top + 1)
                    .attr("width", function(d) { return xScale(d.x); })
                    .attr("height", bar_height)
                    .on("mouseover", function(d){
                        tooltip.text(d.task);
                        tooltip.style("visibility", "visible");})
                    .on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
                    .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

            //exit phase
            rects_base.exit().remove();

            // now the SIMULTATION plot
            //var data_baseline = append_ramp_up(data, 1); // the second param is zero because we are splitting it
            // 0 times which is our baseline.

            var data_sim = append_ramp_up(data, slider_val-1, 20); // the second param is zero because we are splitting it
            // 0 times which is our baseline.

            var stacked_sim = stack(data_sim); // gives us a stacked object with y0 and y...
            // But we don't really want a vertical barchart we want it to be horizontal so, lets rename it

            stacked_sim = rename_y(stacked_sim);

            //maybe bind here the stack array with the color and ramp up numbers, should we use the stack too?

            yScale.domain(stacked_sim.map(function(d){
                return d.task;
            }));

            // join
            var rects_sim = g_sim.selectAll("rect")
                    .data(stacked_sim);

            //enter phase
            rects_sim.enter().append("rect");

            //update phase
            rects_sim.attr("x", function(d){return xScale(d.x0)})
                    .style("fill", function(d){return color(d.task)})
                    .attr("y", bar_spacing/2)
                    .attr("width", function(d) { return xScale(d.x); })
                    .attr("height", bar_height)
                    .on("mouseover", function(d){
                        tooltip.text(d.task);
                        tooltip.style("visibility", "visible");})
                    .on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
                    .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

            //exit phase
            rects_sim.exit().remove();


        }

        var fruits = ["Banana", "Orange", "Apple", "Mango", "Banana", "Orange", "Apple"];
        var a = fruits.indexOf("Apple");
        console.log(a);
	</script>
</body>
<style>
    body {
        font-family: "Lucida Sans Unicode";
        font-size: 13px;
    }
    .explanation{
        display: block;
    }
    .experimentation{
             display: block;
             width: 1000px;
             margin-bottom: 5px;
         }
    #rows{
        display: inline-block;
        width: 500px;
        vertical-align: top;
        margin-right: 100px;
    }
    #columns{
        display: inline-block;
        width: 500px;
    }
    .input_exp{
        width:22px;
        height: 22px;
        font-size: 20px;
        text-align: center;
    }
    .letter{
        color: coral;
        font-weight: bold;
    }
    .number{
        color: brown;
        font-weight: bold;
    }
    .alternate{
        display: inline-block;
        margin-left: 40px;
        margin-right: 40px;
        width: 80px;
    }
    .alternate .input_exp{
        margin-left: 1.5px;
        margin-right: 1.5px;
        margin-bottom: 5px;
    }
    .clocks{
        display: block;
        width: 1000px;
        margin-bottom: 80px;
    }
    .path--background {
        fill: none;
        stroke: #000;
        stroke-width: 2px;
    }
    .label {
        font: 24px sans-serif;
        text-anchor: middle;
    }
    .svg-area{
        float:left;
        display: inline-block;
    }
    .x-axis text {
        font-size: 11px;
    }
    .x-axis line,
    .x-axis path {
        fill: none;
        stroke: grey;
        shape-rendering: crispEdges;
    }
    #axis-label {
        font-size: 15px;
    }
    .tooltip {
        position: absolute;
        pointer-events: none;
        background-color: white;
        font-weight: bold;
    }
    .controls {
        width: 400px;
        display: inline-block;
        border-style: solid;
    }
    .checkbox-grid{
        margin: 5px;
        padding: 5px;
    }
    .checkbox-grid li {
        list-style-type: none;
    }
    #MTlevelSlider{
        width:380px;
        margin-left: 5px;
        margin-right: 5px;
        display: block;
    }
</style>
</html>